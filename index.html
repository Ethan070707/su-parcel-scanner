<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a1628">
<title>SU Parcel Scanner</title>
<link rel="manifest" href="manifest.json">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg-deep: #0a1628;
  --bg-card: #111d33;
  --bg-input: #162240;
  --border: #1e3055;
  --border-focus: #3b82f6;
  --accent: #3b82f6;
  --accent-glow: rgba(59, 130, 246, 0.25);
  --success: #22c55e;
  --success-glow: rgba(34, 197, 94, 0.2);
  --warning: #f59e0b;
  --danger: #ef4444;
  --text-primary: #e8edf5;
  --text-secondary: #8899b4;
  --text-muted: #56687a;
  --radius: 12px;
  --radius-sm: 8px;
}

html, body {
  height: 100%;
  font-family: 'DM Sans', -apple-system, sans-serif;
  background: var(--bg-deep);
  color: var(--text-primary);
  -webkit-font-smoothing: antialiased;
  overscroll-behavior: none;
}

/* ===== HEADER ===== */
.header {
  position: sticky;
  top: 0;
  z-index: 100;
  background: rgba(10, 22, 40, 0.85);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
  padding: 12px 16px;
  display: flex;
  align-items: center;
  gap: 12px;
}

.header-logo {
  width: 36px; height: 36px;
  background: linear-gradient(135deg, var(--accent), #6366f1);
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-weight: 700; font-size: 14px; color: white;
  flex-shrink: 0;
}

.header-text h1 { font-size: 16px; font-weight: 600; letter-spacing: -0.3px; }
.header-text p { font-size: 11px; color: var(--text-muted); margin-top: 1px; }

.header-mode {
  margin-left: auto;
  display: flex;
  background: var(--bg-input);
  border-radius: 8px;
  border: 1px solid var(--border);
  overflow: hidden;
}

.mode-btn {
  padding: 6px 12px;
  font-size: 11px;
  font-weight: 600;
  font-family: inherit;
  border: none;
  background: transparent;
  color: var(--text-muted);
  cursor: pointer;
  transition: all 0.2s;
  letter-spacing: 0.3px;
}

.mode-btn.active {
  background: var(--accent);
  color: white;
}

/* ===== MAIN CONTENT ===== */
.main {
  padding: 16px;
  padding-bottom: 100px;
  max-width: 480px;
  margin: 0 auto;
}

/* ===== SCAN SECTION ===== */
.scan-section {
  margin-bottom: 20px;
}

.scan-actions {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
  margin-bottom: 12px;
}

.scan-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  padding: 20px 12px;
  background: var(--bg-card);
  border: 1.5px dashed var(--border);
  border-radius: var(--radius);
  color: var(--text-secondary);
  font-family: inherit;
  font-size: 12px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.25s;
}

.scan-btn:active {
  transform: scale(0.97);
  border-color: var(--accent);
  background: rgba(59, 130, 246, 0.08);
}

.scan-btn svg { width: 28px; height: 28px; stroke: var(--accent); }

.scan-btn.scanning {
  border-color: var(--accent);
  background: rgba(59, 130, 246, 0.06);
  animation: pulse-border 1.5s infinite;
}

@keyframes pulse-border {
  0%, 100% { border-color: var(--accent); }
  50% { border-color: var(--accent-glow); }
}

/* Scanner viewport */
.scanner-viewport {
  display: none;
  position: relative;
  width: 100%;
  aspect-ratio: 4/3;
  background: #000;
  border-radius: var(--radius);
  overflow: hidden;
  margin-bottom: 12px;
}

.scanner-viewport.active { display: block; }

.scanner-viewport video {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.scanner-overlay {
  position: absolute;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
}

.scan-region {
  width: 45%;
  height: 30%;
  border: 2px solid rgba(59, 130, 246, 0.6);
  border-radius: 12px;
  position: relative;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  padding-bottom: 8px;
}

.scan-hint {
  font-size: 11px;
  color: rgba(255,255,255,0.6);
  text-align: center;
  font-weight: 500;
  letter-spacing: 0.5px;
}

.scan-region::before {
  content: '';
  position: absolute;
  top: 0; left: 10%; right: 10%;
  height: 2px;
  background: var(--accent);
  box-shadow: 0 0 12px var(--accent);
  animation: scan-line 2s ease-in-out infinite;
}

/* Dim area outside scan region */
.scanner-overlay::before {
  content: '';
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.5);
  -webkit-mask: 
    linear-gradient(#000 0 0) top/100% calc(37.5%) no-repeat,
    linear-gradient(#000 0 0) bottom/100% calc(37.5%) no-repeat,
    linear-gradient(#000 0 0) left/calc(30%) 100% no-repeat,
    linear-gradient(#000 0 0) right/calc(30%) 100% no-repeat;
  mask: 
    linear-gradient(#000 0 0) top/100% calc(37.5%) no-repeat,
    linear-gradient(#000 0 0) bottom/100% calc(37.5%) no-repeat,
    linear-gradient(#000 0 0) left/calc(30%) 100% no-repeat,
    linear-gradient(#000 0 0) right/calc(30%) 100% no-repeat;
  pointer-events: none;
}

/* Multi-barcode selection */
.scan-multi-hint {
  font-size: 12px;
  color: var(--text-secondary);
  margin-bottom: 10px;
}

.scan-multi-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
  max-height: 200px;
  overflow-y: auto;
  padding: 0 10px;
}

.scan-multi-item {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 10px 14px;
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.15);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.15s;
}

.scan-multi-item:active {
  background: rgba(59, 130, 246, 0.2);
  border-color: var(--accent);
}

.scan-multi-item-code {
  font-family: 'JetBrains Mono', monospace;
  font-size: 14px;
  font-weight: 500;
  color: white;
  letter-spacing: 0.5px;
}

.scan-multi-item-courier {
  font-size: 11px;
  color: var(--accent);
  font-weight: 500;
}

@keyframes scan-line {
  0%, 100% { top: 0; }
  50% { top: calc(100% - 2px); }
}

.scanner-close {
  position: absolute;
  top: 8px; right: 8px;
  width: 32px; height: 32px;
  background: rgba(0,0,0,0.6);
  border: none;
  border-radius: 50%;
  color: white;
  font-size: 18px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
}

/* Barcode confirmation overlay */
.scan-confirm {
  display: none;
  position: absolute;
  inset: 0;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  align-items: center;
  justify-content: center;
  z-index: 10;
}

.scan-confirm.active { display: flex; }

.scan-confirm-content {
  text-align: center;
  padding: 20px;
  width: 100%;
}

.scan-confirm-icon {
  width: 48px; height: 48px;
  margin: 0 auto 10px;
  background: var(--success);
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  font-size: 24px; color: white;
  animation: pop-in 0.3s ease;
}

@keyframes pop-in {
  0% { transform: scale(0); }
  70% { transform: scale(1.15); }
  100% { transform: scale(1); }
}

.scan-confirm-label {
  font-size: 13px;
  color: var(--text-secondary);
  margin-bottom: 8px;
  font-weight: 500;
}

.scan-confirm-code {
  font-family: 'JetBrains Mono', monospace;
  font-size: 20px;
  font-weight: 600;
  color: white;
  letter-spacing: 1px;
  margin-bottom: 6px;
  word-break: break-all;
  padding: 0 10px;
}

.scan-confirm-courier {
  font-size: 13px;
  color: var(--accent);
  font-weight: 500;
  margin-bottom: 18px;
  min-height: 20px;
}

.scan-confirm-buttons {
  display: flex;
  gap: 10px;
  justify-content: center;
}

.scan-confirm-btn {
  padding: 10px 24px;
  border: none;
  border-radius: 8px;
  font-family: inherit;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s;
}

.scan-confirm-btn:active { transform: scale(0.95); }

.scan-confirm-btn.accept {
  background: var(--success);
  color: white;
}

.scan-confirm-btn.reject {
  background: rgba(255,255,255,0.12);
  color: var(--text-secondary);
}

/* Photo preview */
.photo-preview {
  display: none;
  position: relative;
  width: 100%;
  border-radius: var(--radius);
  overflow: hidden;
  margin-bottom: 12px;
  border: 1px solid var(--border);
}

.photo-preview.active { display: block; }
.photo-preview img { width: 100%; display: block; }

.photo-preview .scanner-close {
  position: absolute;
  top: 8px; right: 8px;
}

/* AI Status */
.ai-status {
  display: none;
  align-items: center;
  gap: 10px;
  padding: 12px 16px;
  background: rgba(59, 130, 246, 0.08);
  border: 1px solid rgba(59, 130, 246, 0.2);
  border-radius: var(--radius-sm);
  margin-bottom: 16px;
  font-size: 13px;
  color: var(--accent);
}

.ai-status.active { display: flex; }
.ai-status.success { 
  background: var(--success-glow); 
  border-color: rgba(34, 197, 94, 0.3); 
  color: var(--success); 
}
.ai-status.error { 
  background: rgba(239, 68, 68, 0.08); 
  border-color: rgba(239, 68, 68, 0.2); 
  color: var(--danger); 
}

.ai-spinner {
  width: 18px; height: 18px;
  border: 2px solid transparent;
  border-top-color: currentColor;
  border-radius: 50%;
  animation: spin 0.8s linear infinite;
  flex-shrink: 0;
}

@keyframes spin { to { transform: rotate(360deg); } }

/* ===== FORM ===== */
.form-section {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.form-group { position: relative; }

.form-group label {
  display: block;
  font-size: 11px;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.8px;
  margin-bottom: 6px;
}

.form-group input, .form-group select, .form-group textarea {
  width: 100%;
  padding: 12px 14px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-primary);
  font-family: inherit;
  font-size: 14px;
  transition: border-color 0.2s, box-shadow 0.2s;
  outline: none;
}

.form-group input:focus, .form-group select:focus, .form-group textarea:focus {
  border-color: var(--border-focus);
  box-shadow: 0 0 0 3px var(--accent-glow);
}

.form-group input::placeholder, .form-group textarea::placeholder {
  color: var(--text-muted);
}

.form-group textarea {
  resize: vertical;
  min-height: 60px;
}

.form-group input.ai-filled {
  border-color: rgba(34, 197, 94, 0.4);
  background: rgba(34, 197, 94, 0.05);
}

.form-row {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 10px;
}

/* Sender quick-select */
.sender-chips {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-top: 6px;
}

.sender-chip {
  padding: 5px 10px;
  background: var(--bg-input);
  border: 1px solid var(--border);
  border-radius: 20px;
  font-size: 11px;
  font-weight: 500;
  color: var(--text-secondary);
  cursor: pointer;
  font-family: inherit;
  transition: all 0.15s;
}

.sender-chip:active, .sender-chip.active {
  background: rgba(59, 130, 246, 0.15);
  border-color: var(--accent);
  color: var(--accent);
}

/* Submit */
.submit-bar {
  position: fixed;
  bottom: 0;
  left: 0; right: 0;
  padding: 12px 16px;
  padding-bottom: max(12px, env(safe-area-inset-bottom));
  background: rgba(10, 22, 40, 0.9);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-top: 1px solid var(--border);
  z-index: 100;
  display: flex;
  gap: 10px;
}

.btn-submit {
  flex: 1;
  padding: 14px;
  background: linear-gradient(135deg, var(--accent), #2563eb);
  border: none;
  border-radius: var(--radius-sm);
  color: white;
  font-family: inherit;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  letter-spacing: 0.2px;
}

.btn-submit:active { transform: scale(0.98); }
.btn-submit:disabled { opacity: 0.4; pointer-events: none; }

.btn-clear {
  padding: 14px 18px;
  background: var(--bg-card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text-secondary);
  font-family: inherit;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
}

/* Toast */
.toast {
  position: fixed;
  top: 20px;
  left: 50%;
  transform: translateX(-50%) translateY(-100px);
  padding: 12px 20px;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 500;
  z-index: 1000;
  transition: transform 0.3s ease;
  white-space: nowrap;
}

.toast.show { transform: translateX(-50%) translateY(0); }
.toast.success { background: var(--success); color: white; }
.toast.error { background: var(--danger); color: white; }

/* OUT form specific */
.out-form { display: none; }
.out-form.active { display: flex; }
.in-form.hidden { display: none; }

/* Config modal */
.config-overlay {
  display: none;
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  z-index: 200;
  align-items: flex-end;
  justify-content: center;
}

.config-overlay.active { display: flex; }

.config-modal {
  background: var(--bg-card);
  border-radius: 16px 16px 0 0;
  width: 100%;
  max-width: 480px;
  max-height: 70vh;
  overflow-y: auto;
  padding: 20px;
}

.config-modal h3 {
  font-size: 16px;
  margin-bottom: 16px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.config-modal .form-group { margin-bottom: 14px; }

.config-modal .btn-save {
  width: 100%;
  padding: 12px;
  background: var(--accent);
  border: none;
  border-radius: var(--radius-sm);
  color: white;
  font-family: inherit;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 8px;
}

.config-trigger {
  position: absolute;
  right: 16px;
  top: 50%;
  transform: translateY(-50%);
  background: none;
  border: none;
  color: var(--text-muted);
  cursor: pointer;
  padding: 4px;
}

.config-trigger svg { width: 18px; height: 18px; }

/* Hidden file input */
#photoInput { display: none; }

/* Section label */
.section-label {
  font-size: 11px;
  font-weight: 600;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 1px;
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.section-label::after {
  content: '';
  flex: 1;
  height: 1px;
  background: var(--border);
}
</style>
</head>
<body>

<!-- Header -->
<div class="header">
  <div class="header-logo">SU</div>
  <div class="header-text">
    <h1>Parcel Scanner</h1>
    <p>Singunion Agency</p>
  </div>
  <div class="header-mode">
    <button class="mode-btn active" onclick="switchMode('in')">IN</button>
    <button class="mode-btn" onclick="switchMode('out')">OUT</button>
  </div>
  <button class="config-trigger" onclick="toggleConfig()">
    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 1v4M12 19v4M4.22 4.22l2.83 2.83M16.95 16.95l2.83 2.83M1 12h4M19 12h4M4.22 19.78l2.83-2.83M16.95 7.05l2.83-2.83"/></svg>
  </button>
</div>

<!-- Main -->
<div class="main">

  <!-- Scan Section -->
  <div class="scan-section">
    <div class="section-label">Quick Capture</div>
    <div class="scan-actions">
      <button class="scan-btn" id="btnBarcode" onclick="startBarcodeScan()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="2" y="4" width="20" height="16" rx="2"/><line x1="6" y1="8" x2="6" y2="16"/><line x1="9" y1="8" x2="9" y2="16"/><line x1="12" y1="8" x2="12" y2="16" stroke-width="2"/><line x1="15" y1="8" x2="15" y2="16"/><line x1="18" y1="8" x2="18" y2="16"/></svg>
        Scan Barcode
      </button>
      <button class="scan-btn" id="btnPhoto" onclick="takePhoto()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2z"/><circle cx="12" cy="13" r="4"/></svg>
        Photo Label
      </button>
    </div>

    <!-- Barcode scanner viewport -->
    <div class="scanner-viewport" id="scannerViewport">
      <video id="scannerVideo" autoplay playsinline muted></video>
      <canvas id="scannerCanvas" style="display:none;"></canvas>
      <div class="scanner-overlay">
        <div class="scan-region">
          <div class="scan-hint">Align barcode here</div>
        </div>
      </div>
      <button class="scanner-close" onclick="stopBarcodeScan()">✕</button>
      <!-- Barcode confirmation overlay: single result -->
      <div class="scan-confirm" id="scanConfirm">
        <div class="scan-confirm-content">
          <div class="scan-confirm-icon">✓</div>
          <div class="scan-confirm-label">Barcode Detected</div>
          <div class="scan-confirm-code" id="scanConfirmCode"></div>
          <div class="scan-confirm-courier" id="scanConfirmCourier"></div>
          <div class="scan-confirm-buttons">
            <button class="scan-confirm-btn reject" onclick="rescanBarcode()">✕ Rescan</button>
            <button class="scan-confirm-btn accept" onclick="acceptBarcode()">✓ Use This</button>
          </div>
        </div>
      </div>
      <!-- Multi-barcode selection overlay -->
      <div class="scan-confirm" id="scanMulti">
        <div class="scan-confirm-content">
          <div class="scan-confirm-icon" style="background:var(--accent);">?</div>
          <div class="scan-confirm-label">Multiple Barcodes Found</div>
          <div class="scan-multi-hint">Tap the correct one:</div>
          <div class="scan-multi-list" id="scanMultiList"></div>
          <div class="scan-confirm-buttons" style="margin-top:12px;">
            <button class="scan-confirm-btn reject" onclick="rescanBarcode()">✕ Rescan</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Photo preview -->
    <div class="photo-preview" id="photoPreview">
      <img id="photoImg" src="" alt="Label photo">
      <button class="scanner-close" onclick="clearPhoto()">✕</button>
    </div>

    <!-- AI Status -->
    <div class="ai-status" id="aiStatus">
      <div class="ai-spinner"></div>
      <span id="aiStatusText">Analyzing label with AI...</span>
    </div>
  </div>

  <!-- IN Parcel Form -->
  <div class="form-section in-form" id="inForm">
    <div class="section-label">Parcel Details (IN)</div>

    <div class="form-group">
      <label>Sender / Courier</label>
      <input type="text" id="inSender" placeholder="DHL, FedEx, UPS...">
      <div class="sender-chips">
        <button class="sender-chip" onclick="selectSender(this, 'DHL')">DHL</button>
        <button class="sender-chip" onclick="selectSender(this, 'FedEx')">FedEx</button>
        <button class="sender-chip" onclick="selectSender(this, 'UPS')">UPS</button>
        <button class="sender-chip" onclick="selectSender(this, 'Singpost')">Singpost</button>
        <button class="sender-chip" onclick="selectSender(this, 'TNT')">TNT</button>
        <button class="sender-chip" onclick="selectSender(this, 'Aramex')">Aramex</button>
      </div>
    </div>

    <div class="form-group">
      <label>AWB / D.O Number</label>
      <input type="text" id="inAwb" placeholder="Tracking / AWB number" style="font-family: 'JetBrains Mono', monospace; letter-spacing: 0.5px;">
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Description</label>
        <input type="text" id="inDescription" placeholder="Parcel / Envelope">
      </div>
      <div class="form-group">
        <label>No. of Pieces</label>
        <input type="text" id="inPieces" placeholder="1 ctn / 2 boxes">
      </div>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Weight</label>
        <input type="text" id="inWeight" placeholder="e.g. 5.2kg">
      </div>
      <div class="form-group">
        <label>GST</label>
        <input type="text" id="inGst" placeholder="Amount / NIL">
      </div>
    </div>

    <div class="form-group">
      <label>Company Name / Sender Name</label>
      <input type="text" id="inCompany" placeholder="Company or person name">
    </div>

    <div class="form-group">
      <label>Vessel Name</label>
      <input type="text" id="inVessel" placeholder="e.g. MV.VOSCO STAR">
    </div>

    <div class="form-group">
      <label>Remarks / Received by</label>
      <textarea id="inRemarks" placeholder="Who received it, special notes..."></textarea>
    </div>
  </div>

  <!-- OUT Parcel Form -->
  <div class="form-section out-form" id="outForm">
    <div class="section-label">Parcel Details (OUT)</div>

    <div class="form-group">
      <label>Delivery Method</label>
      <input type="text" id="outDelivery" placeholder="DHL / UParcel / Self Collect">
      <div class="sender-chips">
        <button class="sender-chip" onclick="selectOutDelivery(this, 'DHL')">DHL</button>
        <button class="sender-chip" onclick="selectOutDelivery(this, 'UParcel')">UParcel</button>
        <button class="sender-chip" onclick="selectOutDelivery(this, 'FedEx')">FedEx</button>
        <button class="sender-chip" onclick="selectOutDelivery(this, 'Self Collect')">Self Collect</button>
      </div>
    </div>

    <div class="form-group">
      <label>(To) Company Name</label>
      <input type="text" id="outCompany" placeholder="Maritec / Viswalab / Nasco">
    </div>

    <div class="form-group">
      <label>Vessel Name</label>
      <input type="text" id="outVessel" placeholder="Vessel name">
    </div>

    <div class="form-group">
      <label>Remarks</label>
      <textarea id="outRemarks" placeholder="1 envelope / 1 bag / details..."></textarea>
    </div>
  </div>
</div>

<!-- Submit Bar -->
<div class="submit-bar">
  <button class="btn-clear" onclick="clearForm()">Clear</button>
  <button class="btn-submit" id="btnSubmit" onclick="submitForm()">
    Submit Parcel IN
  </button>
</div>

<!-- Config Modal -->
<div class="config-overlay" id="configOverlay" onclick="closeConfigIfOutside(event)">
  <div class="config-modal">
    <h3>
      Settings
      <button style="background:none;border:none;color:var(--text-muted);font-size:20px;cursor:pointer" onclick="toggleConfig()">✕</button>
    </h3>
    <div class="form-group">
      <label>n8n Webhook URL (IN Parcel)</label>
      <input type="url" id="cfgWebhookIn" placeholder="https://your-n8n.app.n8n.cloud/webhook/parcel-in">
    </div>
    <div class="form-group">
      <label>n8n Webhook URL (OUT Parcel)</label>
      <input type="url" id="cfgWebhookOut" placeholder="https://your-n8n.app.n8n.cloud/webhook/parcel-out">
    </div>
    <div class="form-group">
      <label>Anthropic API Key (for Photo OCR)</label>
      <input type="password" id="cfgApiKey" placeholder="sk-ant-...">
    </div>
    <div class="form-group">
      <label>Default Received By</label>
      <input type="text" id="cfgReceivedBy" placeholder="Staff name">
    </div>
    <button class="btn-save" onclick="saveConfig()">Save Settings</button>
  </div>
</div>

<!-- Hidden photo input -->
<input type="file" id="photoInput" accept="image/*" capture="environment" onchange="handlePhoto(event)">

<!-- Toast -->
<div class="toast" id="toast"></div>

<!-- BarcodeDetector polyfill / ZXing for broader support -->
<script src="https://unpkg.com/@AminEDEV/zxing-wasm@latest/dist/iife/index.js" onerror="console.log('ZXing not loaded, using native BarcodeDetector')"></script>

<script>
// ==========================================
// CONFIG
// ==========================================
const CONFIG_KEY = 'su_parcel_config';

function loadConfig() {
  try {
    return JSON.parse(localStorage.getItem(CONFIG_KEY)) || {};
  } catch { return {}; }
}

function saveConfig() {
  const config = {
    webhookIn: document.getElementById('cfgWebhookIn').value.trim(),
    webhookOut: document.getElementById('cfgWebhookOut').value.trim(),
    apiKey: document.getElementById('cfgApiKey').value.trim(),
    receivedBy: document.getElementById('cfgReceivedBy').value.trim()
  };
  localStorage.setItem(CONFIG_KEY, JSON.stringify(config));
  toggleConfig();
  showToast('Settings saved', 'success');
}

function populateConfig() {
  const cfg = loadConfig();
  document.getElementById('cfgWebhookIn').value = cfg.webhookIn || '';
  document.getElementById('cfgWebhookOut').value = cfg.webhookOut || '';
  document.getElementById('cfgApiKey').value = cfg.apiKey || '';
  document.getElementById('cfgReceivedBy').value = cfg.receivedBy || '';
}

function toggleConfig() {
  const overlay = document.getElementById('configOverlay');
  overlay.classList.toggle('active');
  if (overlay.classList.contains('active')) populateConfig();
}

function closeConfigIfOutside(e) {
  if (e.target === e.currentTarget) toggleConfig();
}

// ==========================================
// MODE SWITCHING
// ==========================================
let currentMode = 'in';

function switchMode(mode) {
  currentMode = mode;
  document.querySelectorAll('.mode-btn').forEach((btn, i) => {
    btn.classList.toggle('active', (i === 0 && mode === 'in') || (i === 1 && mode === 'out'));
  });
  document.getElementById('inForm').classList.toggle('hidden', mode === 'out');
  document.getElementById('outForm').classList.toggle('active', mode === 'out');
  document.getElementById('btnSubmit').textContent = mode === 'in' ? 'Submit Parcel IN' : 'Submit Parcel OUT';
}

// ==========================================
// BARCODE SCANNING
// ==========================================
let scannerStream = null;
let scanInterval = null;
let pendingBarcode = null;
let stableDetections = {};  // Track how many times each code is detected consecutively
const STABLE_THRESHOLD = 10; // Must detect same code 5 times before showing

async function startBarcodeScan() {
  const viewport = document.getElementById('scannerViewport');
  const video = document.getElementById('scannerVideo');
  stableDetections = {};
  
  try {
    scannerStream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } }
    });
    video.srcObject = scannerStream;
    await video.play();
    viewport.classList.add('active');
    document.getElementById('btnBarcode').classList.add('scanning');

    // Check for BarcodeDetector support
    if ('BarcodeDetector' in window) {
      const detector = new BarcodeDetector({ formats: ['code_128', 'code_39', 'ean_13', 'ean_8', 'qr_code', 'data_matrix', 'itf'] });
      
      scanInterval = setInterval(async () => {
        try {
          // Crop center region from video using canvas
          const centerCodes = await detectCenterRegion(detector, video);
          
          if (centerCodes.length === 0) {
            // Decay counts when nothing detected
            for (const key in stableDetections) {
              stableDetections[key] = Math.max(0, stableDetections[key] - 1);
            }
            return;
          }
          
          // Deduplicate codes
          const uniqueCodes = [...new Set(centerCodes.map(c => c.rawValue))];
          
          // Increment stability counter for detected codes
          uniqueCodes.forEach(code => {
            stableDetections[code] = (stableDetections[code] || 0) + 1;
          });
          
          // Find codes that have reached stability threshold
          const stableCodes = uniqueCodes.filter(code => stableDetections[code] >= STABLE_THRESHOLD);
          
          if (stableCodes.length === 0) return; // Not stable enough yet
          
          // Pause scanning
          if (scanInterval) { clearInterval(scanInterval); scanInterval = null; }
          
          if (stableCodes.length === 1) {
            // Single barcode — show simple confirmation
            showSingleConfirm(stableCodes[0]);
          } else {
            // Multiple barcodes — show selection list
            showMultiSelect(stableCodes);
          }
          
        } catch (e) { /* scanning... */ }
      }, 1000);
    } else {
      showToast('Barcode API not available — use Photo Label instead', 'error');
      setTimeout(() => stopBarcodeScan(), 1500);
    }
  } catch (err) {
    console.error('Camera error:', err);
    showToast('Camera access denied', 'error');
  }
}

async function detectCenterRegion(detector, video) {
  // Use canvas to crop center 70% width × 50% height of the video
  const canvas = document.getElementById('scannerCanvas');
  const vw = video.videoWidth;
  const vh = video.videoHeight;
  
  if (vw === 0 || vh === 0) return [];
  
  // Center crop region — narrow zone to reduce accidental scans
  const cropW = vw * 0.45;
  const cropH = vh * 0.30;
  const cropX = (vw - cropW) / 2;
  const cropY = (vh - cropH) / 2;
  
  canvas.width = cropW;
  canvas.height = cropH;
  
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, cropX, cropY, cropW, cropH, 0, 0, cropW, cropH);
  
  // Detect barcodes only in the cropped center region
  return await detector.detect(canvas);
}

function showSingleConfirm(code) {
  pendingBarcode = code;
  document.getElementById('scanConfirmCode').textContent = code;
  
  const courier = detectCourier(code);
  document.getElementById('scanConfirmCourier').textContent = courier ? `Detected: ${courier}` : '';
  
  document.getElementById('scanConfirm').classList.add('active');
  document.getElementById('scanMulti').classList.remove('active');
}

function showMultiSelect(codes) {
  const list = document.getElementById('scanMultiList');
  list.innerHTML = '';
  
  codes.forEach(code => {
    const courier = detectCourier(code);
    const item = document.createElement('div');
    item.className = 'scan-multi-item';
    item.innerHTML = `
      <span class="scan-multi-item-code">${code}</span>
      <span class="scan-multi-item-courier">${courier || ''}</span>
    `;
    item.onclick = () => selectFromMulti(code);
    list.appendChild(item);
  });
  
  document.getElementById('scanMulti').classList.add('active');
  document.getElementById('scanConfirm').classList.remove('active');
}

function selectFromMulti(code) {
  document.getElementById('scanMulti').classList.remove('active');
  showSingleConfirm(code);
}

function stopBarcodeScan() {
  if (scanInterval) { clearInterval(scanInterval); scanInterval = null; }
  if (scannerStream) { scannerStream.getTracks().forEach(t => t.stop()); scannerStream = null; }
  document.getElementById('scannerViewport').classList.remove('active');
  document.getElementById('btnBarcode').classList.remove('scanning');
  document.getElementById('scanConfirm').classList.remove('active');
  document.getElementById('scanMulti').classList.remove('active');
  pendingBarcode = null;
  stableDetections = {};
}

function handleBarcodeResult(code) {
  showSingleConfirm(code);
}

function acceptBarcode() {
  const code = pendingBarcode;
  if (!code) return;
  
  stopBarcodeScan();
  showToast('Barcode accepted ✓', 'success');
  
  // Fill AWB field
  document.getElementById('inAwb').value = code;
  document.getElementById('inAwb').classList.add('ai-filled');
  
  // Try to detect courier from tracking number format
  const courier = detectCourier(code);
  if (courier) {
    document.getElementById('inSender').value = courier;
    document.getElementById('inSender').classList.add('ai-filled');
    document.querySelectorAll('#inForm .sender-chip').forEach(chip => {
      chip.classList.toggle('active', chip.textContent === courier);
    });
  }
  
  pendingBarcode = null;
}

function rescanBarcode() {
  pendingBarcode = null;
  stableDetections = {};
  document.getElementById('scanConfirm').classList.remove('active');
  document.getElementById('scanMulti').classList.remove('active');
  
  // Resume scanning
  if ('BarcodeDetector' in window) {
    const detector = new BarcodeDetector({ formats: ['code_128', 'code_39', 'ean_13', 'ean_8', 'qr_code', 'data_matrix', 'itf'] });
    const video = document.getElementById('scannerVideo');
    scanInterval = setInterval(async () => {
      try {
        const centerCodes = await detectCenterRegion(detector, video);
        if (centerCodes.length === 0) {
          for (const key in stableDetections) {
            stableDetections[key] = Math.max(0, stableDetections[key] - 1);
          }
          return;
        }
        const uniqueCodes = [...new Set(centerCodes.map(c => c.rawValue))];
        uniqueCodes.forEach(code => {
          stableDetections[code] = (stableDetections[code] || 0) + 1;
        });
        const stableCodes = uniqueCodes.filter(code => stableDetections[code] >= STABLE_THRESHOLD);
        if (stableCodes.length === 0) return;
        if (scanInterval) { clearInterval(scanInterval); scanInterval = null; }
        if (stableCodes.length === 1) {
          showSingleConfirm(stableCodes[0]);
        } else {
          showMultiSelect(stableCodes);
        }
      } catch (e) { /* scanning... */ }
    }, 1000);
  }
}

function detectCourier(trackingNumber) {
  const tn = trackingNumber.toUpperCase();
  // DHL patterns
  if (/^\d{10,11}$/.test(tn) || /^[0-9]{3}[-\s]?[0-9]{8}$/.test(tn)) return 'DHL';
  // FedEx patterns
  if (/^\d{12,22}$/.test(tn) || /^[0-9]{4}[-\s]?[0-9]{4}[-\s]?[0-9]{4}$/.test(tn)) return 'FedEx';
  // UPS patterns
  if (/^1Z[A-Z0-9]{16,18}$/i.test(tn)) return 'UPS';
  // TNT
  if (/^GE\d{9}[A-Z]{2}$/.test(tn)) return 'TNT';
  return null;
}

// ==========================================
// PHOTO + AI OCR
// ==========================================
function takePhoto() {
  document.getElementById('photoInput').click();
}

async function handlePhoto(event) {
  const file = event.target.files[0];
  if (!file) return;

  // Show preview
  const reader = new FileReader();
  reader.onload = async (e) => {
    const base64Full = e.target.result;
    const base64Data = base64Full.split(',')[1];
    
    document.getElementById('photoImg').src = base64Full;
    document.getElementById('photoPreview').classList.add('active');
    
    // Send to Claude Vision API for OCR
    await analyzeWithAI(base64Data, file.type);
  };
  reader.readAsDataURL(file);
  
  // Reset input so same file can be selected again
  event.target.value = '';
}

async function analyzeWithAI(base64Data, mediaType) {
  const cfg = loadConfig();
  if (!cfg.apiKey) {
    showToast('Set Anthropic API key in Settings first', 'error');
    return;
  }

  const status = document.getElementById('aiStatus');
  const statusText = document.getElementById('aiStatusText');
  status.className = 'ai-status active';
  statusText.textContent = 'Analyzing shipping label with AI...';

  try {
    const response = await fetch('https://api.anthropic.com/v1/messages', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-api-key': cfg.apiKey,
        'anthropic-version': '2023-06-01',
        'anthropic-dangerous-direct-browser-access': 'true'
      },
      body: JSON.stringify({
        model: 'claude-sonnet-4-20250514',
        max_tokens: 1024,
        messages: [{
          role: 'user',
          content: [
            {
              type: 'image',
              source: { type: 'base64', media_type: mediaType, data: base64Data }
            },
            {
              type: 'text',
              text: `Analyze this shipping label / courier waybill image. Extract the following information and return ONLY a JSON object (no markdown, no explanation):

{
  "sender_courier": "The courier/logistics company (DHL, FedEx, UPS, TNT, etc.)",
  "awb_number": "The Air Waybill / Tracking / D.O number",
  "description": "Package description (Parcel, Envelope, Box, etc.)",
  "pieces": "Number of pieces (e.g., 1 ctn, 2 boxes)",
  "weight": "Weight with unit (e.g., 5.2kg)",
  "gst": "GST amount if visible, or NIL",
  "company_name": "Shipper/sender company name",
  "vessel_name": "Vessel name if mentioned, or empty string",
  "remarks": "Any notable remarks"
}

For any field not found in the image, use an empty string "". Be precise with the AWB/tracking number.`
            }
          ]
        }]
      })
    });

    if (!response.ok) {
      throw new Error(`API error: ${response.status}`);
    }

    const result = await response.json();
    const text = result.content[0].text;
    
    // Parse JSON from response
    let parsed;
    try {
      // Try to extract JSON from the response
      const jsonMatch = text.match(/\{[\s\S]*\}/);
      parsed = JSON.parse(jsonMatch ? jsonMatch[0] : text);
    } catch {
      throw new Error('Could not parse AI response');
    }

    // Fill form fields
    fillFormFromAI(parsed);
    
    status.className = 'ai-status active success';
    statusText.textContent = '✓ Label analyzed — fields pre-filled';
    setTimeout(() => { status.className = 'ai-status'; }, 4000);

  } catch (err) {
    console.error('AI analysis error:', err);
    status.className = 'ai-status active error';
    statusText.textContent = `✕ Analysis failed: ${err.message}`;
    setTimeout(() => { status.className = 'ai-status'; }, 5000);
  }
}

function fillFormFromAI(data) {
  const fields = [
    ['inSender', data.sender_courier],
    ['inAwb', data.awb_number],
    ['inDescription', data.description],
    ['inPieces', data.pieces],
    ['inWeight', data.weight],
    ['inGst', data.gst],
    ['inCompany', data.company_name],
    ['inVessel', data.vessel_name],
    ['inRemarks', data.remarks]
  ];

  fields.forEach(([id, value]) => {
    if (value && value.trim() !== '') {
      const el = document.getElementById(id);
      el.value = value;
      el.classList.add('ai-filled');
      
      // Auto-highlight sender chip
      if (id === 'inSender') {
        document.querySelectorAll('#inForm .sender-chip').forEach(chip => {
          chip.classList.toggle('active', chip.textContent.toLowerCase() === value.toLowerCase());
        });
      }
    }
  });
}

function clearPhoto() {
  document.getElementById('photoPreview').classList.remove('active');
  document.getElementById('photoImg').src = '';
}

// ==========================================
// SENDER CHIPS
// ==========================================
function selectSender(chip, name) {
  document.querySelectorAll('#inForm .sender-chip').forEach(c => c.classList.remove('active'));
  chip.classList.add('active');
  document.getElementById('inSender').value = name;
}

function selectOutDelivery(chip, name) {
  document.querySelectorAll('#outForm .sender-chip').forEach(c => c.classList.remove('active'));
  chip.classList.add('active');
  document.getElementById('outDelivery').value = name;
}

// ==========================================
// FORM SUBMISSION
// ==========================================
async function submitForm() {
  const cfg = loadConfig();
  const webhookUrl = currentMode === 'in' ? cfg.webhookIn : cfg.webhookOut;

  if (!webhookUrl) {
    showToast('Set webhook URL in Settings first', 'error');
    return;
  }

  const btn = document.getElementById('btnSubmit');
  btn.disabled = true;
  btn.textContent = 'Submitting...';

  let payload;
  if (currentMode === 'in') {
    payload = {
      type: 'IN',
      sender: document.getElementById('inSender').value,
      awb_number: document.getElementById('inAwb').value,
      description: document.getElementById('inDescription').value,
      pieces: document.getElementById('inPieces').value,
      weight: document.getElementById('inWeight').value,
      gst: document.getElementById('inGst').value,
      company_name: document.getElementById('inCompany').value,
      vessel_name: document.getElementById('inVessel').value,
      remarks: document.getElementById('inRemarks').value
    };
  } else {
    payload = {
      type: 'OUT',
      delivery: document.getElementById('outDelivery').value,
      company_name: document.getElementById('outCompany').value,
      vessel_name: document.getElementById('outVessel').value,
      remarks: document.getElementById('outRemarks').value
    };
  }

  try {
    const response = await fetch(webhookUrl, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(payload)
    });

    if (!response.ok) throw new Error(`HTTP ${response.status}`);
    
    showToast(`Parcel ${currentMode.toUpperCase()} recorded ✓`, 'success');
    clearForm();
  } catch (err) {
    console.error('Submit error:', err);
    showToast(`Submit failed: ${err.message}`, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = currentMode === 'in' ? 'Submit Parcel IN' : 'Submit Parcel OUT';
  }
}

// ==========================================
// UTILITIES
// ==========================================
function clearForm() {
  // Clear IN form
  ['inSender', 'inAwb', 'inDescription', 'inPieces', 'inWeight', 'inGst', 'inCompany', 'inVessel', 'inRemarks'].forEach(id => {
    const el = document.getElementById(id);
    el.value = '';
    el.classList.remove('ai-filled');
  });
  // Clear OUT form
  ['outDelivery', 'outCompany', 'outVessel', 'outRemarks'].forEach(id => {
    const el = document.getElementById(id);
    el.value = '';
    el.classList.remove('ai-filled');
  });
  // Clear chips
  document.querySelectorAll('.sender-chip').forEach(c => c.classList.remove('active'));
  // Clear photo
  clearPhoto();
  // Clear scanner
  stopBarcodeScan();
}

function showToast(message, type = 'success') {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = `toast ${type} show`;
  setTimeout(() => { toast.classList.remove('show'); }, 3000);
}

// Init
document.addEventListener('DOMContentLoaded', () => {
  populateConfig();
});
</script>
</body>
</html>
